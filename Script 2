local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")

-- Xóa Menu cũ
if CoreGui:FindFirstChild("VuaBuaChu_Main") then CoreGui:FindFirstChild("VuaBuaChu_Main"):Destroy() end

local ScreenGui = Instance.new("ScreenGui", CoreGui)
ScreenGui.Name = "VuaBuaChu_Main"

local LoginFrame = Instance.new("Frame", ScreenGui)
LoginFrame.Size = UDim2.new(0, 380, 0, 250)
LoginFrame.Position = UDim2.new(0.5, -190, 0.5, -125)
LoginFrame.BackgroundColor3 = Color3.fromRGB(15, 0, 25)
LoginFrame.Active = true
LoginFrame.Draggable = true
Instance.new("UIStroke", LoginFrame).Color = Color3.fromRGB(255, 0, 0)
Instance.new("UICorner", LoginFrame)

local KeyBox = Instance.new("TextBox", LoginFrame)
KeyBox.Size = UDim2.new(0.9, 0, 0, 80) -- Làm to ra để dễ dán key dài
KeyBox.Position = UDim2.new(0.05, 0, 0.2, 0)
KeyBox.PlaceholderText = "DÁN BÙA CHÚ CỰC HẠN VÀO ĐÂY..."
KeyBox.Text = ""
KeyBox.TextWrapped = true
KeyBox.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
KeyBox.TextColor3 = Color3.new(1, 1, 1)
KeyBox.TextSize = 10 -- Chỉnh nhỏ để hiện đủ key admin

local LoginBtn = Instance.new("TextButton", LoginFrame)
LoginBtn.Size = UDim2.new(0.9, 0, 0, 45)
LoginBtn.Position = UDim2.new(0.05, 0, 0.65, 0)
LoginBtn.Text = "GIẢI BÙA (CHECK KEY)"
LoginBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 0)
LoginBtn.TextColor3 = Color3.new(1, 1, 1)

-- HÀM CHUẨN HÓA CHUỖI (QUAN TRỌNG)
local function CleanKey(str)
    return str:gsub("[%s%c]", "") -- Xóa mọi khoảng trắng và ký tự điều khiển tàng hình
end

LoginBtn.MouseButton1Click:Connect(function()
    local inputKey = CleanKey(KeyBox.Text)
    if inputKey == "" then return end

    LoginBtn.Text = "ĐANG GIẢI ẤN..."
    
    local success, response = pcall(function()
        return game:HttpGet("https://raw.githubusercontent.com/chunghoadinh1910-oss/Huyf/refs/heads/main/database.json?nocache=" .. os.time())
    end)

    if success then
        local data = HttpService:JSONDecode(response)
        local found = nil
        
        -- So sánh từng key trong Database với input
        for k, v in pairs(data) do
            if CleanKey(k) == inputKey then
                found = v
                break
            end
        end

        if found then
            LoginBtn.Text = "THÀNH CÔNG!"
            wait(0.5)
            LoginFrame.Visible = false
            _G.StartBuaChu(found.Type, found.Expiry)
        else
            warn("Key nhap: " .. inputKey) -- Hiện log để bạn kiểm tra nếu sai
            LoginBtn.Text = "SAI BÙA CHÚ (SAI KEY)!"
            wait(1.5)
            LoginBtn.Text = "GIẢI BÙA LẠI"
        end
    else
        LoginBtn.Text = "LỖI KẾT NỐI GITHUB!"
    end
end)

-- [ GIỮ NGUYÊN MENU CHỨC NĂNG NHƯ CŨ ] --
_G.StartBuaChu = function(kType, expiry)
    local MainMenu = Instance.new("Frame", ScreenGui)
    MainMenu.Size = UDim2.new(0, 400, 0, 300)
    MainMenu.Position = UDim2.new(0.5, -200, 0.5, -150)
    MainMenu.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
    MainMenu.Draggable = true
    Instance.new("UIStroke", MainMenu).Color = Color3.fromRGB(255, 0, 0)
    
    local Title = Instance.new("TextLabel", MainMenu)
    Title.Text = "BÙA CHÚ: " .. kType:upper()
    Title.Size = UDim2.new(1,0,0,40)
    Title.TextColor3 = Color3.new(1,0,0)
    Title.BackgroundTransparency = 1

    local FarmBtn = Instance.new("TextButton", MainMenu)
    FarmBtn.Size = UDim2.new(0.8,0,0,40)
    FarmBtn.Position = UDim2.new(0.1,0,0.3,0)
    FarmBtn.Text = "AUTO FARM"
    
    local active = false
    FarmBtn.MouseButton1Click:Connect(function()
        active = not active
        FarmBtn.BackgroundColor3 = active and Color3.new(0,1,0) or Color3.new(0.2,0.2,0.2)
        while active do
            pcall(function()
                for _,v in pairs(game.Workspace:GetDescendants()) do
                    if v:IsA("TouchTransmitter") then
                        Players.LocalPlayer.Character.HumanoidRootPart.CFrame = v.Parent.CFrame
                        wait(0.15)
                    end
                end
            end)
            wait(0.1)
        end
    end)
end
