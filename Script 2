-- ========================================================
-- PH·∫¶N 1: ƒêO·∫†N LUA CHECK KEY (C√°i t√¥i v·ª´a ƒë∆∞a)
-- ========================================================
local LINK_REPLIT = "https://1fe3b823-81e5-497f-a748-fa3132dbc137-00-253iz8tfydh8l.pike.replit.dev/" -- Link c·ªßa √¥ng
local KEY = "NH·∫¨P_KEY_V√ÄO_ƒê√ÇY"
local HWID = game:GetService("RbxAnalyticsService"):GetClientId()

local function checkKey()
    local url = LINK_REPLIT .. "/check?key=" .. KEY .. "&hwid=" .. HWID
    local success, result = pcall(function() return game:HttpGet(url) end)

    if success then
        if result == "SUCCESS" then
            print("‚úÖ X√°c th·ª±c th√†nh c√¥ng!")
            
            -- ========================================================
            -- PH·∫¶N 2: D√ÅN TO√ÄN B·ªò SCRIPT CH√çNH C·ª¶A √îNG V√ÄO ƒê√ÇY
            -- ========================================================
            print("ƒêang ch·∫°y Script ch√≠nh...")
            
            -- V√≠ d·ª• script c·ªßa √¥ng:
            -- loadstring(game:HttpGet("link-script-cua-ong"))() 
            -- Ho·∫∑c to√†n b·ªô code Lua c·ªßa √¥ng d√°n h·∫øt v√†o kh√∫c n√†y
            
        elseif result == "BANNED_FOR_SHARING" then
            game.Players.LocalPlayer:Kick("‚ùå BAN: Chia s·∫ª key qu√° 3 m√°y!")
        else
            game.Players.LocalPlayer:Kick("‚ùå Key kh√¥ng h·ª£p l·ªá!")
        end
    else
        warn("‚ö†Ô∏è L·ªói k·∫øt n·ªëi Server Bot!")
    end
end

checkKey() -- B·∫•m chu√¥ng g·ªçi b·∫£o v·ªá ki·ªÉm tralocal HttpService = game:GetService("HttpService")
local LP = game.Players.LocalPlayer
local HWID = game:GetService("RbxAnalyticsService"):GetClientId()

-- --- C·∫§U H√åNH ---
local DATABASE_URL = "https://raw.githubusercontent.com/chunghoadinh1910-oss/Huyf/main/database.json"
local WEBHOOK_URL = "LINK_WEBHOOK_BAO_DO"

-- H√†m g·ª≠i th√¥ng b√°o l·ªói v·ªÅ Discord (Webhook ƒê·ªè)
local function SendAlert(key, reason)
    setclipboard(HWID) -- T·ª± ƒë·ªông copy HWID m√°y m·ªõi cho kh√°ch
    
    local data = {
        ["embeds"] = {{
            ["title"] = "üö® C·∫¢NH B√ÅO B·∫¢O M·∫¨T HWID",
            ["color"] = 16711680, -- M√†u ƒë·ªè r·ª±c
            ["description"] = "Ph√°t hi·ªán ƒëƒÉng nh·∫≠p b·∫•t th∆∞·ªùng!",
            ["fields"] = {
                {["name"] = "T√™n ng∆∞·ªùi ch∆°i", ["value"] = LP.Name .. " (" .. LP.DisplayName .. ")", ["inline"] = true},
                {["name"] = "M√£ Key", ["value"] = "||" .. key .. "||", ["inline"] = true},
                {["name"] = "L√Ω do", ["value"] = "```" .. reason .. "```"},
                {["name"] = "HWID c·ªßa thi·∫øt b·ªã n√†y", ["value"] = "```" .. HWID .. "```"}
            },
            ["footer"] = {["text"] = "Maru Hub Security System"},
            ["timestamp"] = os.date("!%Y-%m-%dT%H:%M:%SZ")
        }}
    }
    
    local headers = {["Content-Type"] = "application/json"}
    local request = (syn and syn.request) or (http and http.request) or http_request or request
    
    if request then
        request({Url = WEBHOOK_URL, Method = "POST", Headers = headers, Body = HttpService:JSONEncode(data)})
    end
end

-- --- GIAO DI·ªÜN RAYFIELD ---
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
local Window = Rayfield:CreateWindow({
    Name = "Maru Hub Premium",
    LoadingTitle = "ƒêang ki·ªÉm tra d·ªØ li·ªáu...",
    LoadingSubtitle = "by Maru Team",
    ConfigurationSaving = {Enabled = true, FileName = "MaruConfig"}
})

local AuthTab = Window:CreateTab("X√°c th·ª±c h·ªá th·ªëng")

AuthTab:CreateInput({
    Name = "Nh·∫≠p m√£ Key c·ªßa b·∫°n",
    PlaceholderText = "M√£ Key (FREE/VIP/KING)",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        _G.Key = Text
    end,
})

AuthTab:CreateButton({
    Name = "ƒêƒÉng Nh·∫≠p",
    Callback = function()
        -- Ki·ªÉm tra d·ªØ li·ªáu t·ª´ GitHub
        local success, result = pcall(function()
            return game:HttpGet(DATABASE_URL)
        end)

        if not success then
            Rayfield:Notify({Title = "L·ªñI K·∫æT N·ªêI", Content = "Kh√¥ng th·ªÉ ƒë·ªçc d·ªØ li·ªáu t·ª´ GitHub!"})
            return
        end

        local db = HttpService:JSONDecode(result)
        local keyData = db[_G.Key]

        if keyData then
            local hwidList = keyData.HWID or {}
            local deviceLimit = keyData.DeviceLimit or 1
            local isRegistered = false

            -- Ki·ªÉm tra xem m√°y hi·ªán t·∫°i c√≥ trong danh s√°ch HWID ƒë√£ l∆∞u kh√¥ng
            for _, savedID in pairs(hwidList) do
                if savedID == HWID then
                    isRegistered = true
                    break
                end
            end

            if isRegistered then
                -- TH√ÄNH C√îNG: M√°y ƒë√£ ƒëƒÉng k√Ω h·ª£p l·ªá
                writefile("Maru_SavedKey.txt", _G.Key) -- T·ª± ƒë·ªông l∆∞u key cho l·∫ßn sau
                
                -- TH√îNG B√ÅO CH√ÄO M·ª™NG NH∆Ø Y√äU C·∫¶U
                Rayfield:Notify({
                    Title = "ƒêƒÇNG NH·∫¨P TH√ÄNH C√îNG",
                    Content = "C·∫£m ∆°n " .. LP.DisplayName .. " ƒë√£ s·ª≠ d·ª•ng key " .. _G.Key,
                    Duration = 5
                })
                
                -- [ CH·ªñ N√ÄY D√ôNG ƒê·ªÇ CH·∫†Y SCRIPT CH√çNH C·ª¶A B·∫†N ]
                print("Quy·ªÅn h·∫°n: " .. keyData.Rank)
                
            elseif #hwidList < deviceLimit then
                -- TR∆Ø·ªúNG H·ª¢P: C√≤n slot m√°y nh∆∞ng m√°y n√†y ch∆∞a ƒë∆∞·ª£c th√™m v√†o DB
                SendAlert(_G.Key, "M√°y m·ªõi y√™u c·∫ßu th√™m v√†o Slot thi·∫øt b·ªã (" .. #hwidList .. "/" .. deviceLimit .. ")")
                
                Rayfield:Notify({
                    Title = "THI·∫æT B·ªä M·ªöI",
                    Content = "ƒê√£ t·ª± copy HWID. H√£y g·ª≠i cho Admin ƒë·ªÉ th√™m v√†o Slot " .. (#hwidList + 1)
                })
            else
                -- TR∆Ø·ªúNG H·ª¢P: H·∫øt gi·ªõi h·∫°n m√°y (Device Limit)
                SendAlert(_G.Key, "ƒê√£ ƒë·∫°t gi·ªõi h·∫°n thi·∫øt b·ªã t·ªëi ƒëa (" .. deviceLimit .. ")")
                
                Rayfield:Notify({
                    Title = "L·ªñI THI·∫æT B·ªä",
                    Content = "Key n√†y ƒë√£ d√πng h·∫øt s·ªë l∆∞·ª£ng m√°y cho ph√©p! Li√™n h·ªá Admin ƒë·ªÉ reset."
                })
            end
        else
            Rayfield:Notify({Title = "SAI KEY", Content = "M√£ Key kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ h·∫øt h·∫°n!"})
        end
    end,
})

-- T·ª∞ ƒê·ªòNG L·∫§Y KEY ƒê√É L∆ØU
if isfile("Maru_SavedKey.txt") then
    local saved = readfile("Maru_SavedKey.txt")
    _G.Key = saved
    Rayfield:Notify({Title = "AUTO FILL", Content = "ƒê√£ t·ª± ƒë·ªông ƒëi·ªÅn Key ƒë√£ l∆∞u."})
end
