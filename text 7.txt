--================================================--
--      VIET HUB | COMMUNITY - DELTA X MOBILE     --
--================================================--

---------------- SERVICES ----------------
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")

---------------- FIX TR√ôNG GUI ----------------
pcall(function()
    if PlayerGui:FindFirstChild("VietHub_KeyUI") then
        PlayerGui.VietHub_KeyUI:Destroy()
    end
    if PlayerGui:FindFirstChild("VietHub_HUD") then
        PlayerGui.VietHub_HUD:Destroy()
    end
end)

---------------- CONFIG ----------------
local HUB_NAME = "Viet Hub | Community"

-- üîë RAW GITHUB key.json (B·∫ÆT BU·ªòC raw.githubusercontent.com)
local KEY_SYNC_LINK = "https://raw.githubusercontent.com/chunghoadinh1910-oss/Huyf/refs/heads/main/key.json"

local KEY_FILE = "VietHub_Key.json"

---------------- BI·∫æN TO√ÄN C·ª§C ----------------
local ONLINE_KEYS = nil
local KEY_CHECKED = false
local HUB_GUI = nil

---------------- TIME ----------------
local function ParseTime(exp)
    if exp == "9999-99-99" then
        return math.huge
    end
    local y,m,d,h,mi = exp:match("(%d+)%-(%d+)%-(%d+)%s*(%d*):?(%d*)")
    if not y then return nil end
    return os.time({
        year = tonumber(y),
        month = tonumber(m),
        day = tonumber(d),
        hour = tonumber(h) or 0,
        min = tonumber(mi) or 0
    })
end

local function IsExpired(exp)
    local t = ParseTime(exp)
    return t and os.time() > t
end

---------------- CLEAN INPUT ----------------
local function CleanInput(input)
    input = tostring(input or "")
    input = input:gsub("%s", "")
    input = input:gsub("\n", "")
    input = input:gsub("\r", "")
    return input
end

---------------- LOAD KEY ONLINE (1 L·∫¶N DUY NH·∫§T) ----------------
local function InitOnlineKeys()
    if ONLINE_KEYS then return true end
    if not KEY_SYNC_LINK or KEY_SYNC_LINK == "" or KEY_SYNC_LINK:find("PUT_RAW") then
        warn("[KEY] Ch∆∞a c·∫•u h√¨nh KEY_SYNC_LINK")
        return false
    end

    local ok, res = pcall(function()
        return game:HttpGet(KEY_SYNC_LINK)
    end)
    if not ok or not res or res == "" then
        warn("[KEY] HttpGet th·∫•t b·∫°i")
        return false
    end

    local success, data = pcall(function()
        return HttpService:JSONDecode(res)
    end)
    if not success or type(data) ~= "table" then
        warn("[KEY] key.json l·ªói")
        return false
    end

    ONLINE_KEYS = data
    return true
end

---------------- SAVE / LOAD LOCAL KEY ----------------
local function SaveKey(key, exp)
    if writefile then
        writefile(KEY_FILE, HttpService:JSONEncode({ Key = key, Exp = exp }))
    end
end

local function LoadKey()
    if readfile and isfile and isfile(KEY_FILE) then
        local d = HttpService:JSONDecode(readfile(KEY_FILE))
        return d.Key, d.Exp
    end
end

---------------- CHECK KEY (KH√îNG HTTP) ----------------
local function CheckKey(input)
    if not ONLINE_KEYS then return false end
    input = CleanInput(input)
    if input == "" then return false end

    if ONLINE_KEYS.VIP
        and input == CleanInput(ONLINE_KEYS.VIP.Key)
        and not IsExpired(ONLINE_KEYS.VIP.Exp) then
        return true, ONLINE_KEYS.VIP.Exp
    end

    if ONLINE_KEYS.FREE
        and input == CleanInput(ONLINE_KEYS.FREE.Key)
        and not IsExpired(ONLINE_KEYS.FREE.Exp) then
        return true, ONLINE_KEYS.FREE.Exp
    end

    return false
end

---------------- UI NH·∫¨P KEY ----------------
local gui = Instance.new("ScreenGui", PlayerGui)
gui.Name = "VietHub_KeyUI"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.fromScale(0.8, 0.35)
frame.Position = UDim2.fromScale(0.1, 0.3)
frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
frame.Active = true
frame.Draggable = true
Instance.new("UICorner", frame)

local box = Instance.new("TextBox", frame)
box.Size = UDim2.fromScale(0.85, 0.3)
box.Position = UDim2.fromScale(0.075, 0.2)
box.PlaceholderText = "Nh·∫≠p key..."
box.TextColor3 = Color3.new(1,1,1)
box.BackgroundColor3 = Color3.fromRGB(45,45,45)
Instance.new("UICorner", box)

local btn = Instance.new("TextButton", frame)
btn.Size = UDim2.fromScale(0.6, 0.25)
btn.Position = UDim2.fromScale(0.2, 0.6)
btn.Text = "CONFIRM"
btn.TextColor3 = Color3.new(1,1,1)
btn.BackgroundColor3 = Color3.fromRGB(70,70,70)
Instance.new("UICorner", btn)

---------------- HUD B·∫¨T / T·∫ÆT ----------------
local function CreateHUD()
    if not HUB_GUI then return end

    local hud = Instance.new("ScreenGui", PlayerGui)
    hud.Name = "VietHub_HUD"
    hud.ResetOnSpawn = false

    local toggle = Instance.new("TextButton", hud)
    toggle.Size = UDim2.fromScale(0.1, 0.06)
    toggle.Position = UDim2.fromScale(0.02, 0.45)
    toggle.Text = "‚óè"
    toggle.TextScaled = true
    toggle.BackgroundColor3 = Color3.fromRGB(40,40,40)
    toggle.TextColor3 = Color3.new(1,1,1)
    toggle.Active = true
    toggle.Draggable = true
    Instance.new("UICorner", toggle)

    local opened = true
    toggle.MouseButton1Click:Connect(function()
        opened = not opened
        HUB_GUI.Enabled = opened
    end)
end

---------------- OPEN HUB (SCRIPT M·∫™U + HUD) ----------------
local function OpenHub()
    gui:Destroy()

    -- üî• SCRIPT M·∫™U (ch·∫°y ch·∫Øc ch·∫Øn)
    loadstring(game:HttpGet(
        "https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source",
        true
    ))()

    -- B·∫Øt GUI hub ƒë·ªÉ HUD ƒëi·ªÅu khi·ªÉn
    task.wait(0.5)
    for _, v in ipairs(PlayerGui:GetChildren()) do
        if v:IsA("ScreenGui") and v.Name ~= "VietHub_KeyUI" and v.Name ~= "VietHub_HUD" then
            HUB_GUI = v
            break
        end
    end

    CreateHUD()
end

---------------- AUTO LOGIN ----------------
task.spawn(function()
    task.wait(1)
    if KEY_CHECKED then return end
    if not InitOnlineKeys() then return end

    local k, exp = LoadKey()
    if k and exp and not IsExpired(exp) and CheckKey(k) then
        KEY_CHECKED = true
        OpenHub()
    end
end)

---------------- MANUAL LOGIN ----------------
btn.MouseButton1Click:Connect(function()
    if KEY_CHECKED then return end
    btn.Active = false
    btn.Text = "ƒêANG KI·ªÇM TRA..."

    local ok, exp = CheckKey(box.Text)
    if ok then
        KEY_CHECKED = true
        SaveKey(box.Text, exp)
        OpenHub()
    else
        btn.Text = "‚ùå SAI KEY"
        task.wait(1)
        btn.Text = "CONFIRM"
        btn.Active = true
    end
end)
